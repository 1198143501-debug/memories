import{x as G,r as b,c as g}from"./index-2FU-56Uf.js";const k=(e,t)=>t.some(n=>e instanceof n);let j,R;function H(){return j||(j=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Q(){return R||(R=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const E=new WeakMap,B=new WeakMap,p=new WeakMap;function X(e){const t=new Promise((n,a)=>{const i=()=>{e.removeEventListener("success",u),e.removeEventListener("error",c)},u=()=>{n(w(e.result)),i()},c=()=>{a(e.error),i()};e.addEventListener("success",u),e.addEventListener("error",c)});return p.set(t,e),t}function Z(e){if(E.has(e))return;const t=new Promise((n,a)=>{const i=()=>{e.removeEventListener("complete",u),e.removeEventListener("error",c),e.removeEventListener("abort",c)},u=()=>{n(),i()},c=()=>{a(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",u),e.addEventListener("error",c),e.addEventListener("abort",c)});E.set(e,t)}let S={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return E.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return w(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function F(e){S=e(S)}function q(e){return Q().includes(e)?function(...t){return e.apply(U(this),t),w(this.request)}:function(...t){return w(e.apply(U(this),t))}}function ee(e){return typeof e=="function"?q(e):(e instanceof IDBTransaction&&Z(e),k(e,H())?new Proxy(e,S):e)}function w(e){if(e instanceof IDBRequest)return X(e);if(B.has(e))return B.get(e);const t=ee(e);return t!==e&&(B.set(e,t),p.set(t,e)),t}const U=e=>p.get(e);function te(e,t,{blocked:n,upgrade:a,blocking:i,terminated:u}={}){const c=indexedDB.open(e,t),y=w(c);return a&&c.addEventListener("upgradeneeded",d=>{a(w(c.result),d.oldVersion,d.newVersion,w(c.transaction),d)}),n&&c.addEventListener("blocked",d=>n(d.oldVersion,d.newVersion,d)),y.then(d=>{u&&d.addEventListener("close",()=>u()),i&&d.addEventListener("versionchange",f=>i(f.oldVersion,f.newVersion,f))}).catch(()=>{}),y}const ne=["get","getKey","getAll","getAllKeys","count"],re=["put","add","delete","clear"],A=new Map;function N(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(A.get(t))return A.get(t);const n=t.replace(/FromIndex$/,""),a=t!==n,i=re.includes(n);if(!(n in(a?IDBIndex:IDBObjectStore).prototype)||!(i||ne.includes(n)))return;const u=async function(c,...y){const d=this.transaction(c,i?"readwrite":"readonly");let f=d.store;return a&&(f=f.index(y.shift())),(await Promise.all([f[n](...y),i&&d.done]))[0]};return A.set(t,u),u}F(e=>({...e,get:(t,n,a)=>N(t,n)||e.get(t,n,a),has:(t,n)=>!!N(t,n)||e.has(t,n)}));const oe=["continue","continuePrimaryKey","advance"],T={},P=new WeakMap,_=new WeakMap,se={get(e,t){if(!oe.includes(t))return e[t];let n=T[t];return n||(n=T[t]=function(...a){P.set(this,_.get(this)[t](...a))}),n}};async function*ae(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,se);for(_.set(n,t),p.set(n,U(t));t;)yield n,t=await(P.get(n)||t.continue()),P.delete(n)}function V(e,t){return t===Symbol.asyncIterator&&k(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&k(e,[IDBIndex,IDBObjectStore])}F(e=>({...e,get(t,n,a){return V(t,n)?ae:e.get(t,n,a)},has(t,n){return V(t,n)||e.has(t,n)}}));const ie="childhood-memories",I="memories",W="liked-memory-ids",L=te(ie,1,{upgrade(e){if(!e.objectStoreNames.contains(I)){const t=e.createObjectStore(I,{keyPath:"id"});t.createIndex("createdAt","createdAt"),t.createIndex("likes","likes")}}}),m=new Map,K=(e,t)=>{if(!t)return"";if(m.has(e))return m.get(e);const n=URL.createObjectURL(t);return m.set(e,n),n},ce=e=>{m.has(e)&&(URL.revokeObjectURL(m.get(e)),m.delete(e))};typeof window<"u"&&window.addEventListener("beforeunload",()=>{m.forEach(e=>URL.revokeObjectURL(e)),m.clear()});const ye=G("memory",()=>{const e=b([]),t=b("time"),n=b(!1),a=b(!1),i=b(new Set),u=()=>{if(!(typeof window>"u"))try{const r=window.localStorage.getItem(W);if(!r)return;const o=JSON.parse(r);i.value=new Set(o)}catch(r){console.error(r)}},c=()=>{typeof window>"u"||window.localStorage.setItem(W,JSON.stringify([...i.value]))};u();const y=g(()=>{const r=[...e.value];return t.value==="heat"?r.sort((o,s)=>s.likes-o.likes||s.createdAt-o.createdAt):r.sort((o,s)=>s.createdAt-o.createdAt)}),d=g(()=>{const r=new Set(e.value.map(o=>o.year));return Array.from(r).sort((o,s)=>Number(o)-Number(s))}),f=g(()=>d.value.map(r=>({year:r,items:e.value.filter(o=>o.year===r).sort((o,s)=>s.createdAt-o.createdAt)}))),v=r=>e.value.find(o=>o.id===r),M=async r=>{await(await L).put(I,r)},J=async()=>{if(a.value)return;const o=await(await L).getAll(I);e.value=o.map(s=>({...s,comments:Array.isArray(s.comments)?s.comments:[],mediaUrl:K(s.id,s.blob)})),a.value=!0},Y=async({file:r,title:o,year:s,story:l})=>{n.value=!0;try{const h=crypto.randomUUID?crypto.randomUUID():Date.now().toString(),D=await r.arrayBuffer(),C=new Blob([D],{type:r.type}),z=r.type.startsWith("video")?"video":"image",$=Date.now(),O={id:h,title:o,year:s,story:l,createdAt:$,likes:0,mediaType:z,blob:C,comments:[]};return await M(O),e.value.unshift({...O,mediaUrl:K(h,C)}),{id:h}}finally{n.value=!1}},x=r=>i.value.has(r);return{memories:e,sortedMemories:y,groupedByYear:f,years:d,sortMode:t,loading:n,initialized:a,loadMemories:J,addMemory:Y,likeMemory:async r=>{const o=v(r);o&&(x(r)?(o.likes=Math.max(0,o.likes-1),i.value.delete(r)):(o.likes+=1,i.value.add(r)),c(),await M({...o,blob:o.blob}))},isLiked:x,addComment:async(r,{author:o,content:s})=>{const l=v(r);if(!l)return null;const h=s?.trim();if(!h)return null;const D={id:crypto.randomUUID?crypto.randomUUID():Date.now().toString(),author:o?.trim()||"匿名",content:h,createdAt:Date.now()};return Array.isArray(l.comments)||(l.comments=[]),l.comments.push(D),await M({...l,blob:l.blob}),D},deleteMemory:async r=>{await(await L).delete(I,r);const s=e.value.findIndex(l=>l.id===r);s!==-1&&(ce(r),e.value.splice(s,1))},getMemoryById:v}});export{ye as u};
