import{x as G,r as w,c as v}from"./index-B-LOWIpF.js";const B=(e,t)=>t.some(n=>e instanceof n);let U,C;function H(){return U||(U=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Q(){return C||(C=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const L=new WeakMap,M=new WeakMap,I=new WeakMap;function X(e){const t=new Promise((n,s)=>{const i=()=>{e.removeEventListener("success",u),e.removeEventListener("error",a)},u=()=>{n(y(e.result)),i()},a=()=>{s(e.error),i()};e.addEventListener("success",u),e.addEventListener("error",a)});return I.set(t,e),t}function Z(e){if(L.has(e))return;const t=new Promise((n,s)=>{const i=()=>{e.removeEventListener("complete",u),e.removeEventListener("error",a),e.removeEventListener("abort",a)},u=()=>{n(),i()},a=()=>{s(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",u),e.addEventListener("error",a),e.addEventListener("abort",a)});L.set(e,t)}let k={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return L.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return y(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function K(e){k=e(k)}function q(e){return Q().includes(e)?function(...t){return e.apply(E(this),t),y(this.request)}:function(...t){return y(e.apply(E(this),t))}}function ee(e){return typeof e=="function"?q(e):(e instanceof IDBTransaction&&Z(e),B(e,H())?new Proxy(e,k):e)}function y(e){if(e instanceof IDBRequest)return X(e);if(M.has(e))return M.get(e);const t=ee(e);return t!==e&&(M.set(e,t),I.set(t,e)),t}const E=e=>I.get(e);function te(e,t,{blocked:n,upgrade:s,blocking:i,terminated:u}={}){const a=indexedDB.open(e,t),m=y(a);return s&&a.addEventListener("upgradeneeded",d=>{s(y(a.result),d.oldVersion,d.newVersion,y(a.transaction),d)}),n&&a.addEventListener("blocked",d=>n(d.oldVersion,d.newVersion,d)),m.then(d=>{u&&d.addEventListener("close",()=>u()),i&&d.addEventListener("versionchange",l=>i(l.oldVersion,l.newVersion,l))}).catch(()=>{}),m}const ne=["get","getKey","getAll","getAllKeys","count"],re=["put","add","delete","clear"],g=new Map;function R(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(g.get(t))return g.get(t);const n=t.replace(/FromIndex$/,""),s=t!==n,i=re.includes(n);if(!(n in(s?IDBIndex:IDBObjectStore).prototype)||!(i||ne.includes(n)))return;const u=async function(a,...m){const d=this.transaction(a,i?"readwrite":"readonly");let l=d.store;return s&&(l=l.index(m.shift())),(await Promise.all([l[n](...m),i&&d.done]))[0]};return g.set(t,u),u}K(e=>({...e,get:(t,n,s)=>R(t,n)||e.get(t,n,s),has:(t,n)=>!!R(t,n)||e.has(t,n)}));const oe=["continue","continuePrimaryKey","advance"],N={},S=new WeakMap,F=new WeakMap,se={get(e,t){if(!oe.includes(t))return e[t];let n=N[t];return n||(n=N[t]=function(...s){S.set(this,F.get(this)[t](...s))}),n}};async function*ie(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,se);for(F.set(n,t),I.set(n,E(t));t;)yield n,t=await(S.get(n)||t.continue()),S.delete(n)}function T(e,t){return t===Symbol.asyncIterator&&B(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&B(e,[IDBIndex,IDBObjectStore])}K(e=>({...e,get(t,n,s){return T(t,n)?ie:e.get(t,n,s)},has(t,n){return T(t,n)||e.has(t,n)}}));const ae="childhood-memories",h="memories",V="liked-memory-ids",p=te(ae,1,{upgrade(e){if(!e.objectStoreNames.contains(h)){const t=e.createObjectStore(h,{keyPath:"id"});t.createIndex("createdAt","createdAt"),t.createIndex("likes","likes")}}}),f=new Map,W=(e,t)=>{if(!t)return"";if(f.has(e))return f.get(e);const n=URL.createObjectURL(t);return f.set(e,n),n},ce=e=>{f.has(e)&&(URL.revokeObjectURL(f.get(e)),f.delete(e))};typeof window<"u"&&window.addEventListener("beforeunload",()=>{f.forEach(e=>URL.revokeObjectURL(e)),f.clear()});const me=G("memory",()=>{const e=w([]),t=w("time"),n=w(!1),s=w(!1),i=w(new Set),u=()=>{if(!(typeof window>"u"))try{const r=window.localStorage.getItem(V);if(!r)return;const o=JSON.parse(r);i.value=new Set(o)}catch(r){console.error(r)}},a=()=>{typeof window>"u"||window.localStorage.setItem(V,JSON.stringify([...i.value]))};u();const m=v(()=>{const r=[...e.value];return t.value==="heat"?r.sort((o,c)=>c.likes-o.likes||c.createdAt-o.createdAt):r.sort((o,c)=>c.createdAt-o.createdAt)}),d=v(()=>{const r=new Set(e.value.map(o=>o.year));return Array.from(r).sort((o,c)=>Number(o)-Number(c))}),l=v(()=>d.value.map(r=>({year:r,items:e.value.filter(o=>o.year===r).sort((o,c)=>c.createdAt-o.createdAt)}))),A=r=>e.value.find(o=>o.id===r),P=async r=>{await(await p).put(h,r)},_=async()=>{if(s.value)return;const o=await(await p).getAll(h);e.value=o.map(c=>({...c,mediaUrl:W(c.id,c.blob)})),s.value=!0},J=async({file:r,title:o,year:c,story:b})=>{n.value=!0;try{const D=crypto.randomUUID?crypto.randomUUID():Date.now().toString(),Y=await r.arrayBuffer(),O=new Blob([Y],{type:r.type}),z=r.type.startsWith("video")?"video":"image",$=Date.now(),j={id:D,title:o,year:c,story:b,createdAt:$,likes:0,mediaType:z,blob:O};return await P(j),e.value.unshift({...j,mediaUrl:W(D,O)}),{id:D}}finally{n.value=!1}},x=r=>i.value.has(r);return{memories:e,sortedMemories:m,groupedByYear:l,years:d,sortMode:t,loading:n,initialized:s,loadMemories:_,addMemory:J,likeMemory:async r=>{const o=A(r);o&&(x(r)?(o.likes=Math.max(0,o.likes-1),i.value.delete(r)):(o.likes+=1,i.value.add(r)),a(),await P({...o,blob:o.blob}))},isLiked:x,deleteMemory:async r=>{await(await p).delete(h,r);const c=e.value.findIndex(b=>b.id===r);c!==-1&&(ce(r),e.value.splice(c,1))},getMemoryById:A}});export{me as u};
